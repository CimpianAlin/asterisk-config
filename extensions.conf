[globals]


[default]
; This is the context for handsets that are allowed to attached via open registration.
; Normally, this context is only used for testing.

; These are test extensions that you might want to disable after installation.

; Record voice file to /tmp directory
exten => 1111,1,Set(CDR(hangupdirection)=A)
same => n,Answer(2000) ; Call 1111 to Record new Sound Files
same => n,Playback(beep)	; play a beep sount to indicat that recording has startet
same => n,Record(/tmp/asterisk-recording:gsm) ; Press # to stop recording
same => n,Wait(2)
same => n,Playback(/tmp/asterisk-recording) ; Listen to your voice
same => n,wait(2)
same => n,Set(CDR(hangupdirection)=SYSTEM)
same => n,Hangup(16)

; Create an extension, 2600, for evaluating echo latency.
exten => 2600,1,Set(CDR(hangupdirection)=A)
same => n,Answer() 
same => n,Echo()
same => n,Set(CDR(hangupdirection)=SYSTEM)
same => n,Hangup(16)

; 2601 is for testing prompts
exten => 2601,1,Set(CDR(hangupdirection)=A)
same => n,Answer(2000)	;allow the channel to be establis
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Playback(followme/sorry)
same => n,Set(CDR(hangupdirection)=SYSTEM)
same => n,Hangup(16)

; 2602 testtone
same => 2602,1,Set(hangupdirection=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Answer()
same => n,Milliwatt()
same => n,Set(hangupdirection=SYSTEM)
same => n,Hangup()

; The 2101 extension is used for factory testing with zoiper.
exten => 2101,1,Set(CDR(hangupdirection)=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Dial(SIP/zoiper,180,g)
same => n,Set(CDR(hangupdirection)=${IF($["${DIALSTATUS}"="ANSWER"]?B:SYSTEM)})
same => n,Hangup(${HANGUPCAUSE})

; The 2100 extension is for factory testing with the test SIM.
exten => 2100,1,Set(CDR(hangupdirection)=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Dial(SIP/IMSI001010000000000,180,g)
same => n,Set(CDR(hangupdirection)=${IF($["${DIALSTATUS}"="ANSWER"]?B:SYSTEM)})
same => n,Hangup(${HANGUPCAUSE})

exten => h,1,Log(NOTICE,${CALLERID(all)} hangupcause=${HANGUPCAUSE} dialstatus=${DIALSTATUS} hangupdirection=${CDR(hangupdirection)} duration=${CDR(duration)} billsec=${CDR(billsec)})

; The messages here need to be installed in /var/lib/asterisk/sounds/xx/, where xx is the 2-letter language code.

[HangupCause]
exten => 0,1000(HangupCause),Playback(PartyNotAnswering,noanswer)	;0 Unspecified. No other cause codes applicable.	; case 5 - C3
;exten => 0,1000(HangupCause),Playback(PartyNotAvailableNow,noanswer)	;0 Unspecified. No other cause codes applicable.	; case 5 - P2.6
exten => 16,1000(HangupCause),Hangup(${HANGUPCAUSE})			;16 NORMAL_CLEARING
exten => 17,1000(HangupCause),Busy(5)					;17 USER_BUSY						; case 1, 2, 3
exten => 19,1000(HangupCause),Playback(NumberOutOfCoverage,noanswer)	;19 NO_ANSWER						; case 6
exten => _X!,1000(HangupCause),Return()

exten => h,1,Log(NOTICE,${CALLERID(all)} hangupcause=${HANGUPCAUSE} dialstatus=${DIALSTATUS} hangupdirection=${CDR(hangupdirection)} duration=${CDR(duration)} billsec=${CDR(billsec)})


[dialGSM](HangupCause)
; GoSub for OpenBTS users
exten => _[+0-9I]!,1,Set(CDR(hangupdirection)=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Dial(SIP/${EXTEN}@${ARG1}:${ARG2},30,g)
same => n,Set(CDR(hangupdirection)=${IF($["${DIALSTATUS}"="ANSWER"]?B:SYSTEM)})
same => n,Goto(${HANGUPCAUSE},HangupCause)


[dialOUT1](HangupCause)
; gosub for outgoing calls (primary)
exten => _[+0-9]!,1,Set(CDR(hangupdirection)=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Dial(SIP/GW1/${EXTEN},180,g) 
same => n,Set(CDR(hangupdirection)=${IF($["${DIALSTATUS}"="ANSWER"]?B:SYSTEM)})
same => n,Goto(${HANGUPCAUSE},HangupCause)


[dialOUT2]
; gosub for outgoing calls (secondary)
exten => _[+0-9]!,1,Set(CDR(hangupdirection)=A)
same => n,GoSub(CallLimit,s,1(${CALLERID(num)},${EXTEN}))
same => n,Dial(SIP/GW2/${ARG1},180,g)
same => n,Set(CDR(hangupdirection)=${IF($["${DIALSTATUS}"="ANSWER"]?B:SYSTEM)})
same => n,Goto(${HANGUPCAUSE},HangupCause)


[outbound-trunk]
; If you had an external trunk, you would dial it here.
exten => _9.,1,GoSub(dialOUT1,${EXTEN:1})                ;Any number starting with 9 (discard '9' while dialing)
same => n,GoSub(dialOUT2,${EXTEN:1})                ;Any number starting with 9 (discard '9' while dialing)
same => n,GoSub(${HANGUPCAUSE},HangupCause)
same => n,Playback(AllCircuitsBusy,noanswer)	;all other error codes
same => n,Congestion(5)

[other-lines]
include => default
include => outbound-trunk
; case 7
exten => i,1,Playback(NumberIncorrect)


[CallLimit]
exten => s,1,Set(GROUP(A)=${ARG1})				;count the caller
same => n,Set(GROUP(B)=${ARG2})					;count the calle
same => n,Set(hangupdirection=SYSTEM)
same => n,NoOP(A=${GROUP_COUNT(${ARG1})} B=${GROUP_COUNT(${ARG2})})
same => n,ExecIf($[${GROUP_COUNT(${ARG1})}>1]?Busy())		;busy if we try to make more that 1 call
same => n,ExecIf($[${GROUP_COUNT(${ARG2})}>1]?Busy())		;busy if we try to receive more that 1 call
same => n,Return()


[phones]
; This is the context for handsets provisioned through the realtime database.
exten => _X.,1,Set(Name=${ODBC_SQL(select dial from dialdata_table where exten=\"${EXTEN}\")})
same => n,GotoIf($["${Name}"=""] ?other-lines,${EXTEN},1)
same => n,Set(IPAddr=${ODBC_SQL(select ipaddr from sip_buddies where username=\"${Name}\")})
same => n,GotoIf($["${IPAddr}"!=""] ?getport)
same => n,Set(IPAddr="127.0.0.1") ; Port was not set, so set to default. Gets around bug in subscriberRegistry
same => n(getport),Set(Port=${ODBC_SQL(select port from sip_buddies where username=\"${Name}\")})
same => n,GotoIf($["${Port}"!=""] ?dialNum)
same => n,Set(Port=5062) ; Port was not set, so set to default. Gets around bug in subscriberRegistry
same => n(dialNum),GoSub(dialGSM,${Name},1(${IPAddr},${Port}))
same => n,Playback(AllCircuitsBusy,noanswer)	;all other error codes
same => n,Congestion(5)



[sip-local]
; This context is the union of all of the in-network contexts.
include => default
include => phones




[sip-external]
; This is the top-level context that gives access to out-of-network calling.
; also includes the in-network calling.
include => default
include => sip-local
include => outbound-trunk

